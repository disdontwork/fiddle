<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            color: white;
        }
        #debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="togglePattern">Toggle Pattern/Video</button><br>
        <input type="range" id="displacement" min="0" max="5" step="0.1" value="1">
    </div>
    <div id="debug"></div>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

        const debug = document.getElementById('debug');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Create test pattern
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.height = 256;
        
        const gradient = ctx.createLinearGradient(0, 0, 256, 256);
        gradient.addColorStop(0, 'white');
        gradient.addColorStop(1, 'black');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 256, 256);

        const patternTexture = new THREE.CanvasTexture(canvas);
        
        // Setup geometry and material
        const geometry = new THREE.PlaneGeometry(5, 5, 128, 128);
        const material = new THREE.MeshStandardMaterial({
            color: 0x808080,
            displacementMap: patternTexture,
            displacementScale: 1.0,
            displacementBias: -0.5,
            side: THREE.DoubleSide,
        });

        const plane = new THREE.Mesh(geometry, material);
        scene.add(plane);

        // Lighting
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        scene.add(new THREE.AmbientLight(0x404040));

        camera.position.z = 5;

        // Video setup
        let isVideo = false;
        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;

        document.getElementById('togglePattern').onclick = async () => {
            isVideo = !isVideo;
            if (isVideo && !video.srcObject) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    await video.play();
                    material.displacementMap = new THREE.VideoTexture(video);
                    debug.textContent = 'Using video texture';
                } catch (err) {
                    console.error(err);
                    debug.textContent = 'Video error: ' + err.message;
                }
            } else {
                material.displacementMap = patternTexture;
                debug.textContent = 'Using pattern texture';
            }
        };

        document.getElementById('displacement').oninput = (e) => {
            material.displacementScale = parseFloat(e.target.value);
            debug.textContent = `Scale: ${material.displacementScale}`;
        };

        function animate() {
            requestAnimationFrame(animate);
            if (material.displacementMap) {
                material.displacementMap.needsUpdate = true;
            }
            plane.rotation.y += 0.01;
            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
